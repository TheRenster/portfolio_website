name: Streamlit keepalive
 
on:
  schedule:
    # Every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch: {}
 
jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Keep Streamlit apps awake (headless browser)
        run: |
          set -euo pipefail

          # Plain curl hits often only load Streamlit's "sleep screen" HTML and does NOT wake the runtime.
          # We use a real (headless) browser to load the page and click the "wake up" button if present.
          #
          # Use the system Chrome on GitHub runners to avoid downloading a browser each run.
          export CHROME_PATH="/usr/bin/google-chrome"

          workdir="$(mktemp -d)"
          pushd "$workdir" >/dev/null
          npm init -y >/dev/null 2>&1
          npm install --silent puppeteer-core@latest >/dev/null 2>&1

          node - <<'NODE'
          const fs = require("fs");
          const puppeteer = require("puppeteer-core");

          const urls = [
            "https://clarity-context-app.streamlit.app/",
            "https://lauren-knox-portfolio.streamlit.app/",
            "https://deep-forecasting-renster.streamlit.app/",
          ];

          const chromePath = process.env.CHROME_PATH || "/usr/bin/google-chrome";
          if (!fs.existsSync(chromePath)) {
            console.error(`Chrome not found at ${chromePath}`);
            process.exit(1);
          }

          async function run() {
            const browser = await puppeteer.launch({
              headless: "new",
              executablePath: chromePath,
              args: [
                "--no-sandbox",
                "--disable-dev-shm-usage",
                "--disable-gpu",
              ],
            });

            let failed = false;
            for (const url of urls) {
              const page = await browser.newPage();
              page.setDefaultTimeout(60_000);
              try {
                console.log(`Visiting: ${url}`);
                const resp = await page.goto(url, { waitUntil: "domcontentloaded" });
                console.log(`HTTP: ${resp ? resp.status() : "no-response"} | final: ${page.url()}`);

                // If the app is asleep, Streamlit shows a wakeup screen with a button.
                const wakeSelector = '[data-testid^="wakeup-button"]';
                const wakeBtn = await page.$(wakeSelector);
                if (wakeBtn) {
                  console.log("Found wake button; clickingâ€¦");
                  await wakeBtn.click();
                  // Give Streamlit a moment to start the runtime.
                  await page.waitForTimeout(15_000);
                } else {
                  console.log("No wake button found.");
                }

                // Keep the page open briefly to count as activity.
                await page.waitForTimeout(10_000);
              } catch (e) {
                failed = true;
                console.error(`ERROR for ${url}: ${e && e.message ? e.message : e}`);
              } finally {
                await page.close().catch(() => {});
              }
            }

            await browser.close();
            if (failed) process.exit(1);
          }

          run().catch((e) => {
            console.error(e);
            process.exit(1);
          });
NODE

          popd >/dev/null

